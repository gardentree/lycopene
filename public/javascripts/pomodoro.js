// Generated by CoffeeScript 1.3.3
(function() {
  var Bell;

  Bell = (function() {

    function Bell(name, button) {
      var sound;
      sound = new lycopene.host.Audio("/sounds/" + name + ".wav");
      sound.addEventListener('ended', function() {
        return button.removeClass('push');
      });
      sound.addEventListener('error', function() {
        return setTimeout(function() {
          return button.removeClass('push');
        }, 1000);
      });
      this.play = function() {
        button.addClass('push');
        return sound.play();
      };
    }

    return Bell;

  })();

  module.exports.build = function(lycopene, $) {
    var controller, sound;
    sound = new lycopene.host.Audio("/sounds/notify.wav");
    controller = (function() {
      var clock, current, linkage, startRest, startWork;
      startWork = new lycopene.AudioWithLoop(sound, 3);
      startRest = new lycopene.AudioWithLoop(sound, 2);
      current = '';
      clock = new lycopene.Clock(function(scene) {
        var minute, second;
        second = ('0' + (scene.remain % 60)).slice(-2);
        minute = ('0' + ((scene.remain - (scene.remain % 60)) / 60)).slice(-2);
        if (current !== scene.state) {
          $('#time').attr('class', scene.state);
          $('#controller').html($('#' + scene.state).html());
          switch (scene.state) {
            case 'working':
              startWork.play();
              break;
            case 'resting':
              startRest.play();
          }
          $('#today').html(scene.today);
          $('#overall').html(scene.overall);
          current = scene.state;
        }
        $('#minute').text(minute);
        $('#second').text(second);
        if (second === 30) {
          return controller.synchronize();
        }
      });
      linkage = lycopene.io.connect(lycopene.host.location.pathname);
      controller = new lycopene.ClockController(linkage, clock);
      (function() {
        var bells;
        bells = {};
        $('#bell > span').each(function() {
          var button, name;
          button = $(this);
          name = button.attr('data-name');
          return bells[name] = new Bell(name, button);
        });
        controller.ring = function(bell) {
          return linkage.emit('ring', bell.attr('data-name'));
        };
        return linkage.on('ring', function(name) {
          return bells[name].play();
        });
      })();
      return controller;
    })();
    controller.prepare = function() {
      return sound.load();
    };
    (function() {
      var connecting;
      connecting = $('#connecting');
      connecting.show();
      return controller.ping(function() {
        controller.synchronize();
        return connecting.hide();
      });
    })();
    return controller;
  };

}).call(this);
